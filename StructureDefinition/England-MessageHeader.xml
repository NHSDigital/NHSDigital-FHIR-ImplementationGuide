<?xml version="1.0" encoding="utf-8"?>
<StructureDefinition xmlns="http://hl7.org/fhir">
  <id value="England-MessageHeader" />
  <url value="https://fhir.nhs.uk/StructureDefinition/England-MessageHeader" />
  <version value="1.0.0" />
  <name value="EnglandMessageHeader" />
  <title value="England MessageHeader" />
  <status value="draft" />
  <date value="2023-06-01" />
  <publisher value="NHS England" />
  <contact>
    <name value="NHS England" />
    <telecom>
      <system value="email" />
      <value value="interoperabilityteam@nhs.net" />
      <use value="work" />
      <rank value="1" />
    </telecom>
  </contact>
  <description value="This profile defines the NHS England constraints and extensions on the FHIR UK Core resource [UK Core MessageHeader](https://simplifier.net/hl7fhirukcorer4/ukcore-messageheader)" />
  <purpose value="This profile carries the header data for a message exchange that is either requesting or responding to an action." />
  <copyright value="&quot;Copyright © 2021+ HL7 UK Licensed under the Apache License, Version 2.0 (the \&quot;License\&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at  http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \&quot;AS IS\&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. HL7® FHIR® standard Copyright © 2011+ HL7 The HL7® FHIR® standard is used under the FHIR license. You may obtain a copy of the FHIR license at  https://www.hl7.org/fhir/license.html.&quot;," />
  <fhirVersion value="4.0.1" />
  <kind value="resource" />
  <abstract value="false" />
  <type value="MessageHeader" />
  <baseDefinition value="https://fhir.hl7.org.uk/StructureDefinition/UKCore-MessageHeader" />
  <derivation value="constraint" />
  <differential>
    <element id="MessageHeader">
      <path value="MessageHeader" />
      <comment value="&lt;a name=&quot;identifiers&quot;&gt;&lt;/a&gt;&#xD;&#xA;### identifiers and message timings&lt;a href=&quot;#identifiers&quot; title=&quot;link to here&quot; class=&quot;self-link&quot;&gt;&lt;i class=&quot;bi-link&quot;&gt;&lt;/i&gt;&lt;/a&gt;&#xD;&#xA;&#xD;&#xA;FHIR messages have two identifiers: the messageIdentifier of the Message (`Bundle.identifier`) and a messageId (`Bundle.id`) which is used in each transport channel . The messageId should be unique within a each message channel/stream. Whenever a message is resent, the messageIdentifier of the Bundle remains the same, but the messageId may change. The response message has its own unique messageIdentifier, the messageIdentifier of the request message can be referenced in the MessageHeader.response.identifier element.&#xD;&#xA;&#xD;&#xA;The `Bundle.identifier`, the messageIdentifier, **MUST** have a UUID value.&#xD;&#xA;&#xD;&#xA;Systems may chose to map *X-Request-ID* header to the `Bundle.id`, messageId. If both are supplied to a `$process-messge` endpoint it is recommended they hold the same values.&#xD;&#xA;&#xD;&#xA;MessageHeader can hold previous and extra messageId's in the {{link:https://fhir.nhs.uk/StructureDefinition/Extension-MessageHeader-messageId}}&#xD;&#xA;&#xD;&#xA;#### Local Part/Addressing (sender and/or destination.receiver)&#xD;&#xA;&#xD;&#xA;When exchanging messages between organisations, local references **SHOULD NOT** be used for `sender` and `destination.receiver` references. Local references can make use of the Extension {{link:https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart}}. Messages between Organisations should be directed to the Organisation. The receiving organisation will take responsibility for delivering to the local address. Sending organisations are not expected to be able to deliver to local entities in another organisation/domain/facility. &#xD;&#xA;&#xD;&#xA;This concept is similar to email addresses `local-part@domain` and also HL7 version 2 combination of `Sending/Receiving Application | Sennding/Receiving Facility` in the MSH segment.&#xD;&#xA;&#xD;&#xA;In the example below, the destination is a clinic (A99968) which part of NHS Trust (RBA). Note also the destination endpoint is for the NHS Trust, who will route the message as required. &#xD;&#xA;&#xD;&#xA;```json&#xD;&#xA;&quot;destination&quot;: [&#xD;&#xA;    {&#xD;&#xA;        &quot;endpoint&quot;: &quot;urn:nhs-uk:addressing:ods:RBA&quot;,&#xD;&#xA;        &quot;receiver&quot;: {&#xD;&#xA;          &quot;extension&quot;: [&#xD;&#xA;              {&#xD;&#xA;                  &quot;url&quot;: &quot;https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart&quot;,&#xD;&#xA;                  &quot;valueReference&quot;: {&#xD;&#xA;                        &quot;identifier&quot;: {&#xD;&#xA;                        &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                        &quot;value&quot;: &quot;A99968&quot;&#xD;&#xA;                    }&#xD;&#xA;                }&#xD;&#xA;&#xD;&#xA;              }&#xD;&#xA;          ],&#xD;&#xA;            &quot;identifier&quot;: {&#xD;&#xA;                &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                &quot;value&quot;: &quot;RBA&quot;&#xD;&#xA;            },&#xD;&#xA;            &quot;display&quot;: &quot;TAUNTON AND SOMERSET NHS FOUNDATION TRUST&quot;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;],&#xD;&#xA;```&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#### example - Prescription, Pharmacy known&#xD;&#xA;&#xD;&#xA;{{render:nominatedPharmacy}}&#xD;&#xA;&#xD;&#xA;In the example below, the prescriber Taunton and Somerset Foundation Trust (RBA), is sending a message to The Simple Pharmacy (VNE51). The `destination.receiver` and `sender` are references to these organisations.&#xD;&#xA;&#xD;&#xA;This message is to be sent via the Electronic Prescription Service, the http address of EPS is held in `destination.endpoint`. Replies to this message can only be received by MESH and the `source.endpoint` is the MESH address of the sending organisation.&#xD;&#xA;&#xD;&#xA;```json&#xD;&#xA;&quot;destination&quot;: [&#xD;&#xA;    {&#xD;&#xA;        &quot;endpoint&quot;: &quot;https://sandbox.api.service.nhs.uk/electronic-prescriptions/$post-message&quot;,&#xD;&#xA;        &quot;receiver&quot;: {&#xD;&#xA;            &quot;identifier&quot;: {&#xD;&#xA;                &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                &quot;value&quot;: &quot;VNE51&quot;&#xD;&#xA;            },&#xD;&#xA;            &quot;display&quot;: &quot;The Simple Pharmacy&quot;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;],&#xD;&#xA;&quot;sender&quot;: {&#xD;&#xA;    &quot;identifier&quot;: {&#xD;&#xA;        &quot;extension&quot;: [&#xD;&#xA;            {&#xD;&#xA;                &quot;url&quot;: &quot;https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart&quot;,&#xD;&#xA;                &quot;valueReference&quot;: {&#xD;&#xA;                        &quot;identifier&quot;: {&#xD;&#xA;                        &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                        &quot;value&quot;: &quot;A99968&quot;&#xD;&#xA;                    }&#xD;&#xA;                }&#xD;&#xA;            }&#xD;&#xA;        ],&#xD;&#xA;        &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;        &quot;value&quot;: &quot;RBA&quot;&#xD;&#xA;    },&#xD;&#xA;    &quot;display&quot;: &quot;TAUNTON AND SOMERSET NHS FOUNDATION TRUST&quot;&#xD;&#xA;},&#xD;&#xA;&quot;source&quot;: {&#xD;&#xA;    &quot;endpoint&quot;: &quot;urn:nhs-uk:addressing:ods:RBA&quot;&#xD;&#xA;}&#xD;&#xA;```&#xD;&#xA;&#xD;&#xA;EPS will now send this message to the pharmacy. This message is collected by the pharmacy using MESH and so the `destination.endpoint` is now the MESH address of the pharmacy. Replies to this message are sent to EPS and so the `source.endpoint` is now the http address of the EPS **$process-message** endpoint.&#xD;&#xA;&#xD;&#xA;```json&#xD;&#xA;&quot;destination&quot;: [&#xD;&#xA;    {&#xD;&#xA;        &quot;endpoint&quot;: &quot;urn:nhs-uk:addressing:ods:VNE51&quot;,&#xD;&#xA;        &quot;receiver&quot;: {&#xD;&#xA;            &quot;identifier&quot;: {&#xD;&#xA;                &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                &quot;value&quot;: &quot;VNE51&quot;&#xD;&#xA;            },&#xD;&#xA;            &quot;display&quot;: &quot;The Simple Pharmacy&quot;&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;],&#xD;&#xA;&quot;sender&quot;: {&#xD;&#xA;    &quot;extension&quot;: [&#xD;&#xA;            {&#xD;&#xA;                &quot;url&quot;: &quot;https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart&quot;,&#xD;&#xA;                &quot;valueReference&quot;: {&#xD;&#xA;                        &quot;identifier&quot;: {&#xD;&#xA;                        &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;                        &quot;value&quot;: &quot;A99968&quot;&#xD;&#xA;                    }&#xD;&#xA;                }&#xD;&#xA;&#xD;&#xA;            }&#xD;&#xA;        ],&#xD;&#xA;    &quot;identifier&quot;: {&#xD;&#xA;        &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/ods-organization-code&quot;,&#xD;&#xA;        &quot;value&quot;: &quot;RBA&quot;&#xD;&#xA;    },&#xD;&#xA;    &quot;display&quot;: &quot;TAUNTON AND SOMERSET NHS FOUNDATION TRUST&quot;&#xD;&#xA;},&#xD;&#xA;&quot;source&quot;: {&#xD;&#xA;    &quot;endpoint&quot;: &quot;https://sandbox.api.service.nhs.uk/electronic-prescriptions/$post-message&quot;&#xD;&#xA;}&#xD;&#xA;```&#xD;&#xA;&#xD;&#xA;#### example - Prescription, Pharmacy not known&#xD;&#xA;&#xD;&#xA;{{render:noNominatedPharmacy}}&#xD;&#xA;&#xD;&#xA;In this example the destination is not known and the message is sent to NHS Digital (X26). &#xD;&#xA;&#xD;&#xA;```json&#xD;&#xA;&quot;destination&quot;: [&#xD;&#xA;    {&#xD;&#xA;        &quot;endpoint&quot;: &quot;https://sandbox.api.service.nhs.uk/electronic-prescriptions/$post-message&quot;,&#xD;&#xA;        &quot;receiver&quot;: {&#xD;&#xA;    &#xD;&#xA;{{render:messageIDs}}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;In addition, a FHIR Message Bundle has two important timestamps:&#xD;&#xA;&#xD;&#xA;The time of sending the message is captured in the timestamp element&#xD;&#xA;The last time the message was updated (e.g. by storing or modification) is captured in the meta.lastUpdated element.&#xD;&#xA;&#xD;&#xA;```json&#xD;&#xA;{&#xD;&#xA;    &quot;resourceType&quot;: &quot;Bundle&quot;,&#xD;&#xA;    &quot;id&quot;: &quot;884cfa4f-7a56-4be5-9592-783ef4f3992a&quot;,&#xD;&#xA;    &quot;meta&quot;: {&#xD;&#xA;        &quot;lastUpdated&quot;: &quot;2020-11-02T01:43:30+00:00&quot;&#xD;&#xA;      },&#xD;&#xA;    &quot;identifier&quot;: {&#xD;&#xA;        &quot;system&quot;: &quot;https://tools.ietf.org/html/rfc4122&quot;,&#xD;&#xA;        &quot;value&quot;: &quot;ad945a29-85f8-439a-b590-6789719adc16&quot;&#xD;&#xA;    },&#xD;&#xA;    &quot;type&quot;: &quot;message&quot;,&#xD;&#xA;    &quot;timestamp&quot;: &quot;2020-11-02T01:43:30+00:00&quot;,&#xD;&#xA;    &quot;entry&quot;: [&#xD;&#xA;        {&#xD;&#xA;            &quot;fullUrl&quot;: &quot;urn:uuid:311316d3-1de0-4f7c-8109-c950ead1c717&quot;,&#xD;&#xA;            &quot;resource&quot;: {&#xD;&#xA;                &quot;resourceType&quot;: &quot;MessageHeader&quot;,&#xD;&#xA;                &quot;extension&quot;: [&#xD;&#xA;                    {&#xD;&#xA;                        &quot;url&quot;: &quot;https://fhir.nhs.uk/StructureDefinition/Extension-Spine-MessageHeader-messageId&quot;,&#xD;&#xA;                        &quot;valueIdentifier&quot;: {&#xD;&#xA;                            &quot;system&quot;: &quot;https://fhir.nhs.uk/Id/prescription-order-number&quot;,&#xD;&#xA;                            &quot;value&quot;: &quot;DC2C66-A1B2C3-23407B&quot;&#xD;&#xA;                        }&#xD;&#xA;                    }&#xD;&#xA;                ]&#xD;&#xA;```&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;### From (source and sender) and To (destination)&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;The *From* is contained in both the `sender` and `source` elements and the *To* is contained in the `destination` array. One source, sender and at least one destination **MUST** be present. &#xD;&#xA;&#xD;&#xA;Messages may be sent over multiple transmission legs (i.e. the first leg uses http and the second MESH). The contents of elements **SHOULD** reflect the current leg only.&#xD;&#xA;&#xD;&#xA;- destination.endpoint&#xD;&#xA;- source.endpoint&#xD;&#xA;- MessageHeader.extension(messageId)&#xD;&#xA;&#xD;&#xA; Endpoints **MUST** point to valid endpoint uri's on each leg of the messages journey, they may not refer to inaccessible endpoints on other legs. See also the destination section below." />
      <constraint>
        <key value="nhsd-11" />
        <severity value="warning" />
        <human value="replacementOf extension is required for update messages" />
        <expression value="event.code.where(substring($this.length()-6) = 'update').exists().not() or (event.code.where(substring($this.length()-6) = 'update').exists() and extension('https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderReplacement').exists())" />
      </constraint>
    </element>
    <element id="MessageHeader.extension">
      <path value="MessageHeader.extension" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="url" />
        </discriminator>
        <rules value="open" />
      </slicing>
      <min value="0" />
    </element>
    <element id="MessageHeader.extension:replacementOf">
      <path value="MessageHeader.extension" />
      <sliceName value="replacementOf" />
      <short value="An extension used to track history of message headers (Previous Bundle.identifier)." />
      <min value="0" />
      <max value="1" />
      <type>
        <code value="Extension" />
        <profile value="https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderReplacement" />
      </type>
      <mustSupport value="true" />
    </element>
    <element id="MessageHeader.event[x]">
      <path value="MessageHeader.event[x]" />
      <type>
        <code value="Coding" />
      </type>
      <mustSupport value="true" />
      <binding>
        <strength value="required" />
        <valueSet value="https://fhir.nhs.uk/ValueSet/England-MessageEvents" />
      </binding>
    </element>
    <element id="MessageHeader.event[x].system">
      <path value="MessageHeader.event[x].system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.event[x].code">
      <path value="MessageHeader.event[x].code" />
      <min value="1" />
    </element>
    <element id="MessageHeader.destination">
      <path value="MessageHeader.destination" />
      <mustSupport value="true" />
    </element>
    <element id="MessageHeader.destination.receiver">
      <path value="MessageHeader.destination.receiver" />
      <min value="1" />
    </element>
    <element id="MessageHeader.destination.receiver.extension">
      <path value="MessageHeader.destination.receiver.extension" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="url" />
        </discriminator>
        <rules value="open" />
      </slicing>
      <min value="0" />
    </element>
    <element id="MessageHeader.destination.receiver.extension:receiverLocalPart">
      <path value="MessageHeader.destination.receiver.extension" />
      <sliceName value="receiverLocalPart" />
      <min value="0" />
      <max value="1" />
      <type>
        <code value="Extension" />
        <profile value="https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart" />
      </type>
    </element>
    <element id="MessageHeader.destination.receiver.identifier">
      <path value="MessageHeader.destination.receiver.identifier" />
      <min value="1" />
    </element>
    <element id="MessageHeader.destination.receiver.identifier.system">
      <path value="MessageHeader.destination.receiver.identifier.system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.destination.receiver.identifier.value">
      <path value="MessageHeader.destination.receiver.identifier.value" />
      <min value="1" />
    </element>
    <element id="MessageHeader.sender">
      <path value="MessageHeader.sender" />
      <mustSupport value="true" />
    </element>
    <element id="MessageHeader.sender.extension">
      <path value="MessageHeader.sender.extension" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="url" />
        </discriminator>
        <rules value="open" />
      </slicing>
      <min value="0" />
    </element>
    <element id="MessageHeader.sender.extension:senderLocalPart">
      <path value="MessageHeader.sender.extension" />
      <sliceName value="senderLocalPart" />
      <min value="0" />
      <max value="1" />
      <type>
        <code value="Extension" />
        <profile value="https://fhir.nhs.uk/StructureDefinition/Extension-England-MessageHeaderLocalPart" />
      </type>
    </element>
    <element id="MessageHeader.sender.identifier">
      <path value="MessageHeader.sender.identifier" />
      <min value="1" />
      <mustSupport value="true" />
    </element>
    <element id="MessageHeader.sender.identifier.system">
      <path value="MessageHeader.sender.identifier.system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.sender.identifier.value">
      <path value="MessageHeader.sender.identifier.value" />
      <min value="1" />
    </element>
    <element id="MessageHeader.author.identifier">
      <path value="MessageHeader.author.identifier" />
      <min value="1" />
    </element>
    <element id="MessageHeader.author.identifier.system">
      <path value="MessageHeader.author.identifier.system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.author.identifier.value">
      <path value="MessageHeader.author.identifier.value" />
      <min value="1" />
    </element>
    <element id="MessageHeader.source">
      <path value="MessageHeader.source" />
      <mustSupport value="true" />
    </element>
    <element id="MessageHeader.responsible.identifier">
      <path value="MessageHeader.responsible.identifier" />
      <min value="1" />
    </element>
    <element id="MessageHeader.responsible.identifier.system">
      <path value="MessageHeader.responsible.identifier.system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.responsible.identifier.value">
      <path value="MessageHeader.responsible.identifier.value" />
      <min value="1" />
    </element>
    <element id="MessageHeader.reason">
      <path value="MessageHeader.reason" />
      <binding>
        <strength value="required" />
        <valueSet value="https://fhir.nhs.uk/ValueSet/England-MessageReasonCode" />
      </binding>
    </element>
    <element id="MessageHeader.reason.coding.system">
      <path value="MessageHeader.reason.coding.system" />
      <min value="1" />
    </element>
    <element id="MessageHeader.reason.coding.code">
      <path value="MessageHeader.reason.coding.code" />
      <min value="1" />
    </element>
    <element id="MessageHeader.focus">
      <path value="MessageHeader.focus" />
      <min value="1" />
    </element>
    <element id="MessageHeader.focus.reference">
      <path value="MessageHeader.focus.reference" />
      <min value="1" />
    </element>
  </differential>
</StructureDefinition>