<?xml version="1.0" encoding="utf-8"?>
<StructureDefinition xmlns="http://hl7.org/fhir">
  <url value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
  <name value="NHSDigitalTask" />
  <status value="draft" />
  <fhirVersion value="4.0.1" />
  <kind value="resource" />
  <abstract value="false" />
  <type value="Task" />
  <baseDefinition value="http://hl7.org/fhir/StructureDefinition/Task" />
  <derivation value="constraint" />
  <differential>
    <element id="Task">
      <path value="Task" />
      <definition value="FHIR Task usage and scope is defined as &#xD;&#xA;&#xD;&#xA;&gt; A task resource describes an activity that can be performed and tracks the state of completion of that activity. It is a representation that an activity should be or has been initiated, and eventually, represents the successful or unsuccessful completion of that activity. Note that there are a variety of processes associated with making and processing orders. Some orders may be handled immediately by automated systems but most require real world actions by one or more humans. Some orders can only be processed when other real world actions happen, such as a patient presenting themselves so that the action to be performed can actually be performed. Often these real world dependencies are only implicit in the order details." />
      <comment value="Within NHS Digital this resource will often be associated with workflow management. &#xD;&#xA;&#xD;&#xA;Similar concepts exist outside of NHS Digital for example a GP system has the concept of Task and this includes:&#xD;&#xA;&#xD;&#xA;- telephone patient&#xD;&#xA;- form to complete&#xD;&#xA;- prescription&#xD;&#xA;- referral&#xD;&#xA;- book appointment&#xD;&#xA;- medication review&#xD;&#xA;&#xD;&#xA;These are complemented with more detailed Task management around:&#xD;&#xA;&#xD;&#xA;- pathology&#xD;&#xA;- medicine management and also includes EPS&#xD;&#xA;  - Rejected Prescriptions&#xD;&#xA;  - Cancelled Prescriptions&#xD;&#xA;  - Subsequent cancellation rejections &#xD;&#xA;- referrals&#xD;&#xA;&#xD;&#xA;NHS App also includes the ability to order **repeat prescriptions** which relates to the GP systems **prescriptions**." />
    </element>
    <element id="Task.extension">
      <path value="Task.extension" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="url" />
        </discriminator>
        <rules value="open" />
      </slicing>
      <min value="0" />
    </element>
    <element id="Task.extension:agent">
      <path value="Task.extension" />
      <sliceName value="agent" />
      <short value="Provenance of the resource" />
      <definition value="Is used as the author on request resources." />
      <min value="0" />
      <max value="1" />
      <type>
        <code value="Extension" />
        <profile value="https://fhir.nhs.uk/StructureDefinition/Extension-Provenance-agent" />
      </type>
    </element>
    <element id="Task.identifier">
      <path value="Task.identifier" />
      <min value="1" />
      <mustSupport value="true" />
    </element>
    <element id="Task.status">
      <path value="Task.status" />
      <definition value="These workflow tasks have `status` which indicates the Task status. &#xD;&#xA;&#xD;&#xA;The following diagram reflects the &quot;typical&quot; state machine for Task. Note that not all states will be supported by all workflows and that some workflows may support additional transitions, including transitions from terminal states (e.g. back to &quot;in-progress&quot; from &quot;failed&quot; or &quot;completed&quot;).&#xD;&#xA;&#xD;&#xA;&lt;img src=&quot;https://www.hl7.org/fhir/task-state-machine.svg&quot;&gt;&lt;/img&gt;&#xD;&#xA;&#xD;&#xA;For example: &#xD;&#xA;&#xD;&#xA;A patient requesting a repeat prescription would ask for task with code `fulfil` used with `103742009 | Renewal of prescription` and a status of `requested`.  &#xD;&#xA;Once reviewed (by a clinician), the task status would be changed to `accepted`. When the task is then picked up (`in-progress`) and the related *MedicationRequest* is sent, the status would change to `completed`." />
      <mustSupport value="true" />
    </element>
    <element id="Task.intent">
      <path value="Task.intent" />
      <mustSupport value="true" />
    </element>
    <element id="Task.code">
      <path value="Task.code" />
      <definition value="The reasonCode's are complemented with [task-code](https://www.hl7.org/fhir/valueset-task-code.html) which indicates the type of action to be performed. &#xD;&#xA;&#xD;&#xA;For example:&#xD;&#xA;&#xD;&#xA;The code `fulfil` used with `182836005 | Review of medication` means a task to review medication.&#xD;&#xA;The code `approve` used with `103742009 | Renewal of prescription` is a task for a clinician to approve the issue of a repeat medication." />
      <mustSupport value="true" />
      <binding>
        <strength value="extensible" />
        <valueSet value="https://fhir.nhs.uk/ValueSet/England-task-code" />
      </binding>
    </element>
    <element id="Task.focus">
      <path value="Task.focus" />
      <definition value="Tasks are often generated as a consequence of other workflows or relate to FHIR Workflow resources. For example a repeat medication request will be related to a previous `MedicationRequest` or a medication reconciliation may relate to a hospital admissions `Encounter/EpisodeOfCare`. This is carried in the `focus` element.&#xD;&#xA;&#xD;&#xA;`focus` can be omitted. For example if an ED generated a Medication Review as a result of COPD Emergency encounter they may chose to include a reference to the Encounter but they may decide instead to use a more specific reasonCode such as `394720003 | Asthma medication review`." />
      <type>
        <code value="Reference" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/England-Appointment" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/England-ServiceRequest" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Bundle-FHIRMessage" />
        <targetProfile value="https://fhir.hl7.org.uk/StructureDefinition/UKCore-MedicationRequest" />
      </type>
    </element>
    <element id="Task.for">
      <path value="Task.for" />
      <min value="1" />
      <constraint>
        <key value="patient-reference" />
        <severity value="error" />
        <human value="An identifier reference or resource reference must be provided" />
        <expression value="(reference.exists() or identifier.exists())" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="patient-nhs" />
        <severity value="error" />
        <human value="Supplied NHS Number is outside the English and Welsh NHS Number range or length of the number is wrong." />
        <expression value="identifier.where(system='https://fhir.nhs.uk/Id/nhs-number').exists().not() or (identifier.where(system='https://fhir.nhs.uk/Id/nhs-number').exists()  and identifier.where(system='https://fhir.nhs.uk/Id/nhs-number').value.matches('^([456789]{1}[0-9]{9})$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Claim" />
      </constraint>
      <mustSupport value="true" />
    </element>
    <element id="Task.for.identifier">
      <path value="Task.for.identifier" />
      <min value="1" />
    </element>
    <element id="Task.for.identifier.system">
      <path value="Task.for.identifier.system" />
      <min value="1" />
    </element>
    <element id="Task.for.identifier.value">
      <path value="Task.for.identifier.value" />
      <min value="1" />
    </element>
    <element id="Task.requester">
      <path value="Task.requester" />
      <type>
        <code value="Reference" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-PractitionerRole-Contained" />
        <aggregation value="contained" />
      </type>
      <constraint>
        <key value="usercode-reference" />
        <severity value="warning" />
        <human value="An identifier reference plus a display name or resource reference must be provided" />
        <expression value="(reference.exists() or (identifier.exists() and display.exists()))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-nmc" />
        <severity value="error" />
        <human value="NMC must be of the format NNANNNNA" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/nmc-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/nmc-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/nmc-number').value.matches('^[0-9]{2}[A-Z]{1}[0-9]{4}[A-Z]{1}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-gmp" />
        <severity value="error" />
        <human value="GMP must be of the format GNNNNNNN and not be a spurious code (starts with G6 or G7)" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/gmp-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/gmp-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/gmp-number').value.matches('^[G]{1}[01234589]{1}[0-9]{6}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-gmc" />
        <severity value="error" />
        <human value="GMC must be of the format CNNNNNNN" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/gmc-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/gmc-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/gmc-number').value.matches('^[C]{1}[0-9]{7}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-gphc" />
        <severity value="error" />
        <human value="GPHC must be of the format NNNNNNN" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/gphc-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/gphc-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/gphc-number').value.matches('^[0-9]{7}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-hcpc" />
        <severity value="error" />
        <human value="HCPC must be of the format AANNNNNN" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/hcpc-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/hcpc-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/hcpc-number').value.matches('^[A-Z]{2}[0-9]{6}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <constraint>
        <key value="usercode-din" />
        <severity value="error" />
        <human value="DIN format must be NNNNNN" />
        <expression value="identifier.exists().not() or identifier.where(system='https://fhir.hl7.org.uk/Id/din-number').exists().not() or (identifier.where(system='https://fhir.hl7.org.uk/Id/din-number').exists()  and identifier.where(system='https://fhir.hl7.org.uk/Id/din-number').value.matches('^[0-9]{6}$'))" />
        <source value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Task" />
      </constraint>
      <mustSupport value="true" />
    </element>
    <element id="Task.requester.identifier.system">
      <path value="Task.requester.identifier.system" />
      <min value="1" />
    </element>
    <element id="Task.requester.identifier.value">
      <path value="Task.requester.identifier.value" />
      <min value="1" />
    </element>
    <element id="Task.owner">
      <path value="Task.owner" />
      <type>
        <code value="Reference" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Patient" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-PractitionerRole" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Practitioner" />
        <targetProfile value="https://fhir.nhs.uk/StructureDefinition/NHSDigital-Organization" />
      </type>
      <mustSupport value="true" />
    </element>
    <element id="Task.owner.identifier.system">
      <path value="Task.owner.identifier.system" />
      <min value="1" />
    </element>
    <element id="Task.owner.identifier.value">
      <path value="Task.owner.identifier.value" />
      <min value="1" />
    </element>
    <element id="Task.reasonCode">
      <path value="Task.reasonCode" />
      <definition value="In FHIR Task these types of workflow would be represented via **reasonCode** and/or **reasonReference**&#xD;&#xA;&#xD;&#xA;For medication this is probably SNOMED CT based using codes under the SNOMED CT 182832007 Medication management and includes codes such as:&#xD;&#xA;&#xD;&#xA;| SNOMED CT | Display |&#xD;&#xA;|--|--|&#xD;&#xA;| 182836005 | Review of medication | &#xD;&#xA;| 430193006 | Medication Reconciliation |&#xD;&#xA;| 103742009 | Renewal of prescription |&#xD;&#xA;| 33633005 | Prescription of drug |&#xD;&#xA;| 373784005 | Dispensing medication |&#xD;&#xA;&#xD;&#xA;&lt;br/&gt;&#xD;&#xA;&#xD;&#xA;For referral management&#xD;&#xA;&#xD;&#xA;| SNOMED CT | Display |&#xD;&#xA;|--|--|&#xD;&#xA;| &lt;a href=&quot;https://ontoserver.csiro.au/shrimp/?concept=3457005&amp;version=http%3A%2F%2Fsnomed.info%2Fsct%2F83821000000107%2Fversion%2F20211124&amp;valueset=http%3A%2F%2Fsnomed.info%2Fsct%2F83821000000107%3Ffhir_vs&amp;fhir=https%3A%2F%2Fontology.nhs.uk%2Fauthoring%2Ffhir&quot;&gt;3457005&lt;/a&gt; | Patient Referral |&#xD;&#xA;| &lt;a href=&quot;https://ontoserver.csiro.au/shrimp/?concept=185499000&amp;version=http%3A%2F%2Fsnomed.info%2Fsct%2F83821000000107%2Fversion%2F20211124&amp;valueset=http%3A%2F%2Fsnomed.info%2Fsct%2F83821000000107%3Ffhir_vs&amp;fhir=https%3A%2F%2Fontology.nhs.uk%2Fauthoring%2Ffhir&quot;&gt;185499000&lt;/a&gt;| Expedite appointment |" />
      <mustSupport value="true" />
    </element>
    <element id="Task.reasonCode.coding">
      <path value="Task.reasonCode.coding" />
      <slicing>
        <discriminator>
          <type value="value" />
          <path value="system" />
        </discriminator>
        <rules value="open" />
      </slicing>
    </element>
    <element id="Task.reasonCode.coding.system">
      <path value="Task.reasonCode.coding.system" />
      <min value="1" />
    </element>
    <element id="Task.reasonCode.coding.code">
      <path value="Task.reasonCode.coding.code" />
      <min value="1" />
    </element>
    <element id="Task.reasonCode.coding.display">
      <path value="Task.reasonCode.coding.display" />
      <min value="1" />
    </element>
    <element id="Task.reasonCode.coding:SNOMED">
      <path value="Task.reasonCode.coding" />
      <sliceName value="SNOMED" />
    </element>
    <element id="Task.reasonCode.coding:SNOMED.system">
      <path value="Task.reasonCode.coding.system" />
      <fixedUri value="http://snomed.info/sct" />
    </element>
    <element id="Task.input">
      <path value="Task.input" />
      <mustSupport value="true" />
    </element>
  </differential>
</StructureDefinition>